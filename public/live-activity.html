<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Activity Feed - ERI Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .back-btn {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #2d3748;
        }

        .pulse {
            width: 12px;
            height: 12px;
            background: #48bb78;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(72, 187, 120, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(72, 187, 120, 0);
            }
        }

        .activity-stats {
            display: flex;
            gap: 30px;
            font-size: 0.9em;
            color: #718096;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        .activity-stream {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-height: 700px;
            overflow-y: auto;
        }

        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .stream-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2d3748;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 6px 16px;
            border: none;
            border-radius: 20px;
            background: #e2e8f0;
            color: #4a5568;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #a8edea;
            color: #2d3748;
            font-weight: 600;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: #f7fafc;
            margin: 0 -15px;
            padding: 20px 15px;
            border-radius: 8px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .avatar-user { background: linear-gradient(45deg, #667eea, #764ba2); }
        .avatar-system { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .avatar-course { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .avatar-achievement { background: linear-gradient(45deg, #43e97b, #38f9d7); }

        .activity-content {
            flex: 1;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .activity-title {
            font-weight: 600;
            color: #2d3748;
            line-height: 1.4;
        }

        .activity-time {
            font-size: 0.8em;
            color: #a0aec0;
            flex-shrink: 0;
            margin-left: 15px;
        }

        .activity-description {
            color: #718096;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .activity-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.8em;
            color: #a0aec0;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .widget-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-box {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .metric-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
            display: block;
        }

        .metric-label {
            font-size: 0.8em;
            color: #718096;
            margin-top: 5px;
        }

        .top-users {
            list-style: none;
        }

        .top-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .top-user:last-child {
            border-bottom: none;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9em;
        }

        .user-activity {
            font-size: 0.8em;
            color: #718096;
        }

        .user-score {
            font-weight: 600;
            color: #48bb78;
            font-size: 0.9em;
        }

        .chart-widget {
            height: 250px;
        }

        canvas {
            max-height: 200px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: -1;
            }
        }

        .new-activity {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ö° Live Activity Feed</h1>
        <p>Real-time user engagement monitoring</p>
    </div>

    <div class="container">
        <a href="/" class="back-btn">‚Üê Back to Main Dashboard</a>

        <div class="status-bar">
            <div class="live-indicator">
                <div class="pulse"></div>
                <span>Live Feed Active</span>
            </div>
            <div class="activity-stats">
                <div class="stat">
                    <span>üìä</span>
                    <span>247 activities/min</span>
                </div>
                <div class="stat">
                    <span>üë•</span>
                    <span>1,439 active users</span>
                </div>
                <div class="stat">
                    <span>üéØ</span>
                    <span>87% engagement rate</span>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="activity-stream">
                <div class="stream-header">
                    <h2 class="stream-title">üîÑ Activity Stream</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active">All</button>
                        <button class="filter-btn">Users</button>
                        <button class="filter-btn">Courses</button>
                        <button class="filter-btn">System</button>
                    </div>
                </div>

                <div class="activity-feed" id="activityFeed">
                    <div class="activity-item">
                        <div class="activity-avatar avatar-user">JS</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">John Smith completed "Advanced React Patterns"</div>
                                <div class="activity-time">2 seconds ago</div>
                            </div>
                            <div class="activity-description">
                                Achieved 95% completion rate and unlocked the "React Master" badge
                            </div>
                            <div class="activity-meta">
                                <span>üìö Course Progress</span>
                                <span>üèÜ Badge Earned</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-avatar avatar-system">SYS</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">Weekly engagement report generated</div>
                                <div class="activity-time">15 seconds ago</div>
                            </div>
                            <div class="activity-description">
                                Processed 12,847 user interactions and identified 23 at-risk learners
                            </div>
                            <div class="activity-meta">
                                <span>üìä Analytics</span>
                                <span>‚ö†Ô∏è Risk Alert</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-avatar avatar-user">MJ</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">Maria Johnson started "Machine Learning Fundamentals"</div>
                                <div class="activity-time">32 seconds ago</div>
                            </div>
                            <div class="activity-description">
                                New user enrollment detected, triggered welcome sequence
                            </div>
                            <div class="activity-meta">
                                <span>üöÄ New Start</span>
                                <span>üìß Nudge Sent</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-avatar avatar-achievement">ACH</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">15 users achieved "7-day streak" milestone</div>
                                <div class="activity-time">1 minute ago</div>
                            </div>
                            <div class="activity-description">
                                Batch achievement unlock triggered, celebrating consistent learning
                            </div>
                            <div class="activity-meta">
                                <span>üéâ Milestone</span>
                                <span>üî• Streak</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-avatar avatar-course">WEB</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">High engagement detected in "Web Development Bootcamp"</div>
                                <div class="activity-time">2 minutes ago</div>
                            </div>
                            <div class="activity-description">
                                45 active learners, 3.2x above average session duration
                            </div>
                            <div class="activity-meta">
                                <span>üìà High Activity</span>
                                <span>‚è±Ô∏è Extended Sessions</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-avatar avatar-user">AK</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">Alex Kim received personalized course recommendation</div>
                                <div class="activity-time">3 minutes ago</div>
                            </div>
                            <div class="activity-description">
                                AI recommended "Data Science with Python" based on learning history
                            </div>
                            <div class="activity-meta">
                                <span>ü§ñ AI Recommendation</span>
                                <span>üéØ Personalized</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-avatar avatar-system">SYS</div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">Nudge campaign "Weekend Learning" launched</div>
                                <div class="activity-time">4 minutes ago</div>
                            </div>
                            <div class="activity-description">
                                Targeted 2,847 inactive users with re-engagement notifications
                            </div>
                            <div class="activity-meta">
                                <span>üì¢ Campaign</span>
                                <span>üéØ Targeted</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="widget">
                    <h3 class="widget-title">üìä Real-time Metrics</h3>
                    <div class="metric-grid">
                        <div class="metric-box">
                            <span class="metric-number">1,439</span>
                            <div class="metric-label">Active Now</div>
                        </div>
                        <div class="metric-box">
                            <span class="metric-number">247</span>
                            <div class="metric-label">Activities/min</div>
                        </div>
                        <div class="metric-box">
                            <span class="metric-number">89%</span>
                            <div class="metric-label">Completion Rate</div>
                        </div>
                        <div class="metric-box">
                            <span class="metric-number">23</span>
                            <div class="metric-label">New Signups</div>
                        </div>
                    </div>
                </div>

                <div class="widget">
                    <h3 class="widget-title">üî• Most Active Users</h3>
                    <ul class="top-users">
                        <li class="top-user">
                            <div class="user-avatar">JS</div>
                            <div class="user-info">
                                <div class="user-name">John Smith</div>
                                <div class="user-activity">3 courses completed today</div>
                            </div>
                            <div class="user-score">2,847</div>
                        </li>
                        <li class="top-user">
                            <div class="user-avatar">MJ</div>
                            <div class="user-info">
                                <div class="user-name">Maria Johnson</div>
                                <div class="user-activity">7-day learning streak</div>
                            </div>
                            <div class="user-score">1,923</div>
                        </li>
                        <li class="top-user">
                            <div class="user-avatar">AK</div>
                            <div class="user-info">
                                <div class="user-name">Alex Kim</div>
                                <div class="user-activity">5 badges earned</div>
                            </div>
                            <div class="user-score">1,654</div>
                        </li>
                        <li class="top-user">
                            <div class="user-avatar">SM</div>
                            <div class="user-info">
                                <div class="user-name">Sarah Miller</div>
                                <div class="user-activity">4h 23m session</div>
                            </div>
                            <div class="user-score">1,456</div>
                        </li>
                    </ul>
                </div>

                <div class="widget chart-widget">
                    <h3 class="widget-title">üìà Activity Trend</h3>
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let activityChart;
        
        // Load live activity data
        async function loadActivityData() {
            try {
                const response = await fetch('/api/dashboard/activity/realtime?limit=10');
                const data = await response.json();
                
                if (data.success) {
                    updateActivityDashboard(data.activities, data.metrics);
                }
            } catch (error) {
                console.error('Error loading activity data:', error);
                showActivityDemo();
            }
        }
        
        function updateActivityDashboard(activities, metrics) {
            // Update real-time metrics in status bar
            const statsElements = document.querySelectorAll('.activity-stats .stat span:last-child');
            if (statsElements.length >= 3) {
                statsElements[0].textContent = `${metrics.activitiesPerMin} activities/min`;
                statsElements[1].textContent = `${metrics.activeNow} active users`;
                statsElements[2].textContent = `${Math.round(metrics.engagementRate * 100)}% engagement rate`;
            }
            
            // Update sidebar metrics
            const metricBoxes = document.querySelectorAll('.metric-number');
            if (metricBoxes.length >= 4) {
                metricBoxes[0].textContent = metrics.activeNow.toLocaleString();
                metricBoxes[1].textContent = metrics.activitiesPerMin;
                metricBoxes[2].textContent = `${Math.round(metrics.engagementRate * 100)}%`;
                metricBoxes[3].textContent = metrics.newSignupsToday;
            }
            
            // Update activity feed
            updateActivityFeed(activities);
            
            // Update chart with new data point
            updateActivityChart();
        }
        
        function updateActivityFeed(activities) {
            const feedContainer = document.getElementById('activityFeed');
            
            // Clear existing activities
            feedContainer.innerHTML = '';
            
            activities.forEach(activity => {
                const activityElement = createActivityElement(activity);
                feedContainer.appendChild(activityElement);
            });
        }
        
        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'activity-item';
            
            const avatarClass = getAvatarClass(activity.icon);
            const timeAgo = getTimeAgo(activity.timestamp);
            
            div.innerHTML = `
                <div class="activity-avatar ${avatarClass}">${activity.user.avatar}</div>
                <div class="activity-content">
                    <div class="activity-header">
                        <div class="activity-title">${activity.title}</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                    <div class="activity-description">
                        ${activity.description}
                    </div>
                    <div class="activity-meta">
                        ${activity.meta.map(tag => `<span>${tag}</span>`).join('')}
                    </div>
                </div>
            `;
            
            return div;
        }
        
        function getAvatarClass(iconType) {
            switch(iconType) {
                case 'user': return 'avatar-user';
                case 'system': return 'avatar-system';
                case 'course': return 'avatar-course';
                case 'achievement': return 'avatar-achievement';
                default: return 'avatar-user';
            }
        }
        
        function getTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            return 'just now';
        }
        
        function initializeActivityChart() {
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 6}, (_, i) => {
                        const date = new Date();
                        date.setHours(date.getHours() - (5 - i));
                        return date.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                    }),
                    datasets: [{
                        label: 'Activities',
                        data: [180, 220, 195, 247, 310, 285],
                        borderColor: '#a8edea',
                        backgroundColor: 'rgba(168, 237, 234, 0.2)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#fed6e3',
                        pointBorderColor: '#a8edea',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function updateActivityChart() {
            if (activityChart) {
                // Add new data point with some randomization for real-time feel
                const now = new Date();
                const timeLabel = now.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                const newValue = 200 + Math.floor(Math.random() * 150);
                
                activityChart.data.labels.shift();
                activityChart.data.labels.push(timeLabel);
                activityChart.data.datasets[0].data.shift();
                activityChart.data.datasets[0].data.push(newValue);
                activityChart.update('none'); // Smooth update without animation
            }
        }
        
        function showActivityDemo() {
            console.log('Using activity demo data as fallback');
        }

        // Filter buttons functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // In a real app, this would filter the activities
                console.log('Filter applied:', this.textContent);
                // Reload data with filter (could be implemented)
                loadActivityData();
            });
        });
        
        // WebSocket connection for real-time updates
        let socket;
        
        function initializeWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', () => {
                    console.log('Connected to real-time updates');
                    socket.emit('join_dashboard');
                });
                
                socket.on('dashboard_joined', (data) => {
                    console.log('Dashboard real-time updates active:', data.message);
                });
                
                socket.on('metrics_update', (metrics) => {
                    updateRealtimeMetrics(metrics);
                });
                
                socket.on('new_activity', (activity) => {
                    addNewActivityToFeed(activity);
                });
                
                socket.on('disconnect', () => {
                    console.log('Disconnected from real-time updates');
                });
                
                socket.on('error', (error) => {
                    console.error('WebSocket error:', error);
                });
                
            } catch (error) {
                console.error('WebSocket initialization failed:', error);
            }
        }
        
        function updateRealtimeMetrics(metrics) {
            // Update status bar metrics
            const statsElements = document.querySelectorAll('.activity-stats .stat span:last-child');
            if (statsElements.length >= 3) {
                statsElements[0].textContent = `${metrics.activitiesPerMin} activities/min`;
                statsElements[1].textContent = `${metrics.activeNow} active users`;
                statsElements[2].textContent = `${Math.round(metrics.engagementRate * 100)}% engagement rate`;
            }
            
            // Update sidebar metrics
            const metricBoxes = document.querySelectorAll('.metric-number');
            if (metricBoxes.length >= 4) {
                metricBoxes[0].textContent = metrics.activeNow.toLocaleString();
                metricBoxes[1].textContent = metrics.activitiesPerMin;
                metricBoxes[2].textContent = `${Math.round(metrics.engagementRate * 100)}%`;
                metricBoxes[3].textContent = metrics.newSignupsToday;
            }
        }
        
        function addNewActivityToFeed(activity) {
            const feedContainer = document.getElementById('activityFeed');
            const newActivityElement = createActivityElement(activity);
            
            // Add animation class for smooth entry
            newActivityElement.classList.add('new-activity');
            
            // Insert at the top
            feedContainer.insertBefore(newActivityElement, feedContainer.firstChild);
            
            // Remove oldest items if more than 12
            const items = feedContainer.querySelectorAll('.activity-item');
            if (items.length > 12) {
                items[items.length - 1].remove();
            }
            
            // Update activity chart with new data point
            updateActivityChart();
        }
        
        // Initialize the page
        function initializePage() {
            initializeActivityChart();
            loadActivityData();
            initializeWebSocket();
            
            // Fallback refresh in case WebSocket fails
            setInterval(loadActivityData, 30000); // Less frequent since we have real-time updates
        }
        
        // Start the app when page loads
        initializePage();
    </script>
</body>
</html>
